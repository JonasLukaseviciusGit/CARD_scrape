import requests
from pymongo import MongoClient
import passwords
import json

email = passwords.email

client = MongoClient('localhost', 27017)
db = client['Articles1']

collections = db.list_collection_names()
print(collections)
collection = collections[0]

print(collection)

records = db[collection].find({})

_ids = []
dois = []
for record in records:
    _ids.append(record['_id'])
    dois.append(record['response']['doi'])

sublists = [dois[i:i + 200] for i in range(0, len(dois), 200)]

pmcids = []
for sublist in sublists:
    dois_joined = ','.join(sublist)
    url = f'https://www.ncbi.nlm.nih.gov/pmc/utils/idconv/v1.0/?email={email}&ids={dois_joined}&format=json'
    response = requests.get(url).json()['records']
    for result in response:
        if 'pmcid' in result:
            pmcids.append(result['pmcid'])
        else:
            pmcids.append(None)

with open(r"C:\Users\HP\Desktop\b1\dois-1.json", "w") as file:
    json.dump(pmcids, file)

for pmcid in pmcids:
    print(pmcid)
print('')
print(len(pmcids))
print('')

for i in range(len(list(records))):
    _id = _ids[i-1]
    pmcid = pmcids[i-1]
    db[collection].update_one({"_id": _id}, {"$set": {"pmcid": pmcid}})
print('done')
